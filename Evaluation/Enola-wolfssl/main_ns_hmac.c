#include <arm_cmse.h>
#include "RTE_Components.h"                        /* Component selection */
#include CMSIS_device_header
#include "Secure_Functions.h"     /* Secure Code Entry Points */
#include "enola-measurement.h"
#include "simple-crypto.h"
#include "hash.h"
#include "rsa.h"
#include "aes.h"
#include "hmac.h"

uint8_t key[] = {0x12, 0xc2, 0x5d, 0x66, 0x67, 0x66, 0x27, 0x68, 0x12, 0xc2, 0x5d, 0x66, 0x67, 0x66, 0x27, 0x68, 0x12, 0xc2, 0x5d, 0x66, 0x67, 0x66, 0x27, 0x68, 0x12, 0xc2, 0x5d, 0x66, 0x67, 0x66, 0x27, 0x68};

uint8_t plaintext[] = {0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c,
                         0x1a, 0x1b, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0xa, 0xb, 0x1c, 0x2d, 0xe, 0xf, 0x2d, 0x4c};

  unsigned char hmac_output[SHA256_DIGEST_SIZE];
static uint32_t x;

int main (void)
{
    /* exercise some core register from Non Secure Mode */
  x = __get_MSP();
  x = __get_PSP();

  SystemCoreClockUpdate();
  
  /* HMAC context */
  Hmac hmac;
  
  /* Initialize HMAC */
  if (wc_HmacInit(&hmac, NULL, INVALID_DEVID) != 0) {
      return -1;
  }

  /* Set up HMAC with the key and SHA-256 algorithm */
  if (wc_HmacSetKey(&hmac, WC_SHA256, (const byte*)key, strlen(key)) != 0) {
      wc_HmacFree(&hmac);
      return -1;
  }
  
  /* Perform HMAC on the input data */
  if (wc_HmacUpdate(&hmac, (const byte*)plaintext, strlen(plaintext)) != 0) {
      wc_HmacFree(&hmac);
      return -1;
  }
  
  /* Finalize HMAC and get the output */
  if (wc_HmacFinal(&hmac, hmac_output) != 0) {
      wc_HmacFree(&hmac);
      return -1;
  }
  print_occurence_trace();
}